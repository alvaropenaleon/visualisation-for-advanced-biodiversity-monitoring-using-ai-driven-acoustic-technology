name: CI smoke test

on:
  push:
  pull_request:

jobs:
  smoke:
    runs-on: ubuntu-latest

    env:
      POSTGRES_PASSWORD: postgrespassword
      GRAFANA_USER: admin
      GRAFANA_PASSWORD: admin

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Docker Compose version
        run: docker compose version

      - name: Start stack
        run: |
          docker compose -f compose.yml up -d

      - name: Wait for services to be ready
        run: bash ci/wait-for-services.sh

      - name: Assert Postgres is responding
        run: bash ci/assert-postgres.sh

      - name: Tear down stack
        if: always()
        run: docker compose -f compose.yml down -v
